from modules.config import model
from modules.config import get_db_url
from langgraph.checkpoint.postgres import PostgresSaver
from fastapi import FastAPI, Request, Depends
from fastapi.middleware.cors import CORSMiddleware
from modules.verify import verify_jwt_from_cookie
from modules.agent import PresentationAgent
app = FastAPI()


app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # セキュリティのため本番では特定のドメインに限定する
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


@app.get("/api/")
async def root():
    return {"message": "Hello World"}

@app.get("/api/health")
async def health():
    return {"message": "OK"}

@app.post("/api/presentation")
async def suggest(request: Request):
    with PostgresSaver.from_conn_string(get_db_url()) as checkpointer:
        checkpointer.setup()
        body = await request.json()
        user_background = body["user_background"]
        state = body["state"]
        print("state",state)
        agent = PresentationAgent(model,k=3,checkpointer=checkpointer)
        result = agent.run(user_request=state["user_request"],thread_id=state["thread_id"],persona_list=state["persona_list"],common_background=state["common_background"])
        fake_result ={
            "thread_id": "b315d660-ee1d-4f6f-bd41-6648fe8bb9e1",
            "common_background": "ITベンチャー企業に勤めています fake",
            "user_request": "user request fake",
            "persona_list": [
                {
                    "name": "佐藤健太AAAA",
                    "background": "30歳男性。AI開発部門で働くエンジニア。大学でコンピュータサイエンスを専攻し、5年間の経験を持つ。新しい技術に対する好奇心が強く、特に機械学習に興味を持っている。"
                },
                {
                    "name": "山田美咲BBBB",
                    "background": "25歳女性。マーケティング部門で働くデジタルマーケティングスペシャリスト。AIの活用によるデータ分析に関心があり、SNSを通じたプロモーション戦略を担当している。最近、AIツールを使ったキャンペーンの効果測定に取り組んでいる。"
                },
                {
                    "name": "鈴木一郎CCCC",
                    "background": "45歳男性。経営戦略部門のマネージャー。AIのビジネス活用に関する豊富な知識を持ち、企業の成長戦略を策定する役割を担っている。技術的なバックグラウンドはないが、AIのトレンドに敏感で、業界の動向を常に追っている。"
                }
            ],
            "persona_confirmed": False,
            "interview_result": [{'persona': {'name': '佐藤健一', 'background': '35歳男性。IT企業の開発部門でソフトウェアエンジニアとして働いている。プログラミング言語はJavaとPythonが得意で、最近はAI技術に興味を持っている。おもちゃメーカーのプロジェクトで、子供向けの教育アプリの開発に携わっている。'}, 'question': '佐藤健一さんが子供向けの教育アプリを開発する際に、AI技術をどのように活用して、子供たちの学習効果を高める機能を実装したいと考えていますか？', 'answer': '子供向けの教育アプリを開発する際に、AI技術を活用して学習効果を高めるために、いくつかの機能を実装したいと考えています。\n\n1. **パーソナライズ学習**: AIを使って子供一人ひとりの学習進度や理解度を分析し、それに基づいてカスタマイズされた学習プランを提供します。例えば、特定のトピックでつまずいている場合、そのトピックに関連する問題や練習を増やすことができます。\n\n2. **インタラクティブなフィードバック**: 子供が問題を解いた際に、AIがリアルタイムでフィードバックを提供します。正解の場合は褒めるメッセージを、間違えた場合はどの部分が間違っていたのかを具体的に説明し、次にどうすれば良いかを示すことで、学びを深めます。\n\n3. **ゲーム要素の導入**: AIを活用して、子供たちの興味を引くためのゲーム要素を組み込みます。例えば、学習の進捗に応じてキャラクターが成長したり、新しいレベルが解放されたりする仕組みを作ることで、モチベーションを高めます。\n\n4. **自然言語処理**: 子供たちが質問をしたり、意見を述べたりする際に、自然言語処理を用いてその内容を理解し、適切な応答を返す機能を実装します。これにより、子供たちが自分の言葉で学びを深めることができます。\n\n5. **データ分析による改善**: アプリの使用データをAIで分析し、どの機能が効果的か、どの部分で子供たちがつまずいているかを把握します。これにより、アプリの改善点を見つけ、より効果的な学習体験を提供することができます。\n\nこれらの機能を通じて、子供たちが楽しく、かつ効果的に学べる環境を提供したいと考えています。AI技術を活用することで、より個別化された学習体験を実現し、子供たちの成長をサポートできると信じています。'}, {'persona': {'name': '山田美咲', 'background': '28歳女性。IT企業のマーケティング部門でデジタルマーケティング担当。SNSやオンライン広告を駆使しておもちゃメーカーの新商品をプロモーションしている。データ分析に強く、ユーザーのニーズを把握することに情熱を持っている。'}, 'question': '山田美咲さんが新商品プロモーションのためにSNSやオンライン広告を活用する際、どのようなデータ分析手法を用いてユーザーのニーズを把握し、効果的なマーケティング戦略を立てていますか？', 'answer': '私は新商品プロモーションのために、いくつかのデータ分析手法を活用しています。具体的には以下のような方法です。\n\n1. **ユーザーセグメンテーション**: SNSやオンライン広告から得られるデモグラフィックデータや行動データを基に、ターゲットユーザーをセグメント化します。年齢、性別、地域、興味関心などの要素を考慮し、各セグメントに最適なメッセージを届けることができます。\n\n2. **A/Bテスト**: 広告や投稿の内容、画像、CTA（コール・トゥ・アクション）などを変えて、どのバージョンが最も効果的かをテストします。これにより、ユーザーの反応をリアルタイムで把握し、最適なコンテンツを見つけ出すことができます。\n\n3. **ソーシャルリスニング**: SNS上でのユーザーの声やトレンドを分析するために、ソーシャルリスニングツールを使用します。これにより、ユーザーがどのようなことに興味を持っているのか、どのような問題を抱えているのかを把握し、プロモーション戦略に反映させることができます。\n\n4. **コンバージョン率分析**: オンライン広告やSNSキャンペーンの効果を測定するために、コンバージョン率を分析します。どのチャネルやキャンペーンが最も高いコンバージョンを生んでいるのかを把握し、リソースを最適に配分します。\n\n5. **ユーザー行動分析**: ウェブサイトやアプリのユーザー行動をトラッキングし、どのページが最も訪問されているか、どのコンテンツがエンゲージメントを高めているかを分析します。これにより、ユーザーの興味を引くコンテンツを強化することができます。\n\nこれらの手法を組み合わせることで、ユーザーのニーズを深く理解し、効果的なマーケティング戦略を立てることができると考えています。データに基づいた意思決定が、成功の鍵だと思っています。'}, {'persona': {'name': '鈴木太郎', 'background': '45歳男性。IT企業のITサポート部門でマネージャーを務めている。おもちゃメーカーの社内システムの運用管理を担当しており、チームのリーダーとして若手社員の育成にも力を入れている。技術的な知識は広範囲にわたり、特にネットワークセキュリティに精通している。'}, 'question': '鈴木太郎さんがチームの若手社員を育成する際に、特に重視しているネットワークセキュリティのトピックや実践的なスキルは何ですか？また、それをどのように教育プログラムに組み込んでいますか？', 'answer': '私がチームの若手社員を育成する際に特に重視しているネットワークセキュリティのトピックは、以下のようなものです。\n\n1. **基本的なセキュリティ原則**: CIAトライアングル（機密性、完全性、可用性）や、リスク管理の基本を理解させることが重要です。これにより、セキュリティの重要性を認識させることができます。\n\n2. **ファイアウォールと侵入検知システム**: ネットワークの防御の要となるファイアウォールの設定や、侵入検知システムの役割について学ぶことは、実践的なスキルとして非常に重要です。\n\n3. **脆弱性管理**: システムやアプリケーションの脆弱性を特定し、対策を講じる方法を教えています。具体的には、定期的なスキャンやパッチ管理の重要性を強調します。\n\n4. **セキュリティポリシーの理解**: 企業のセキュリティポリシーやコンプライアンスに関する知識を深めることで、実際の業務におけるセキュリティの実践を促進します。\n\n5. **インシデント対応**: セキュリティインシデントが発生した際の対応手順や、事後分析の重要性についても教育しています。\n\nこれらのトピックを教育プログラムに組み込む方法としては、以下のようなアプローチを取っています。\n\n- **ワークショップやセミナー**: 定期的に外部の専門家を招いて、最新のセキュリティトレンドや技術についてのセミナーを開催しています。\n\n- **ハンズオン演習**: 実際のシステムを使った演習を通じて、理論だけでなく実践的なスキルを身につけさせることを重視しています。例えば、仮想環境を用いて脆弱性スキャンやインシデント対応のシミュレーションを行います。\n\n- **メンタリング制度**: 若手社員には、経験豊富なメンバーがメンターとしてつき、日常業務を通じて学びを深められるようにしています。\n\n- **定期的なフィードバック**: 学んだ内容を実務に活かせるよう、定期的にフィードバックを行い、成長を促す環境を整えています。\n\nこれらの取り組みを通じて、若手社員がネットワークセキュリティに関する知識と実践的なスキルを身につけ、自信を持って業務に取り組めるように育成しています。'}],
            "iteration": 1,
            "is_satisfied": False,
            "presentation": {'title': 'AI技術を活用した子供向け教育アプリの開発', 'contents': [{'content_name': 'イントロダクション', 'content_purpose': 'プレゼンテーションの目的と概要を説明する', 'content_detail': '本プレゼンテーションでは、AI技術を活用した子供向け教育アプリの開発における重要な機能とその効果について説明します。', 'content_time': 5}, {'content_name': 'パーソナライズ学習の重要性', 'content_purpose': 'AIを用いた個別学習の利点を理解する', 'content_detail': 'AIを活用して子供一人ひとりの学習進度や理解度を分析し、カスタマイズされた学習プランを提供する方法について説明します。', 'content_time': 10}, {'content_name': 'インタラクティブなフィードバックの実装', 'content_purpose': 'リアルタイムフィードバックの効果を学ぶ', 'content_detail': '子供が問題を解いた際にAIがリアルタイムでフィードバックを提供する仕組みとその学習効果について解説します。', 'content_time': 10}, {'content_name': 'ゲーム要素の導入', 'content_purpose': '学習のモチベーションを高める方法を探る', 'content_detail': 'AIを活用したゲーム要素の組み込みによる子供たちの興味を引く方法とその効果について説明します。', 'content_time': 10}, {'content_name': '自然言語処理の活用', 'content_purpose': '子供たちのコミュニケーション能力を向上させる', 'content_detail': '自然言語処理を用いて子供たちの質問に応答する機能の実装方法とその利点について解説します。', 'content_time': 10}, {'content_name': 'データ分析によるアプリ改善', 'content_purpose': 'アプリの効果を最大化するためのデータ活用法を学ぶ', 'content_detail': 'アプリの使用データをAIで分析し、改善点を見つける方法について説明します。', 'content_time': 10}, {'content_name': 'まとめと質疑応答', 'content_purpose': 'プレゼンテーションの内容を振り返り、質問に答える', 'content_detail': '本プレゼンテーションの要点をまとめ、参加者からの質問に答えます。', 'content_time': 5}]}
        }

        return result


# uvicorn main:app --reload